globalVariables(c("Reference", "Comparison","Proportion","Change","value","Identity","PropCys"))

#########
# Plots #
#########
percent <- function(x, digits = 1, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

#' Plot a heatmap of the column identities between two multiple sequence alignments
#'
#' @param x          an object of type "pairwise alignment comparison" (typically the summary file generated by compare_alignments)
#' @param display    display this plot (default = TRUE)
#' 
#' @export
#' @examples
#' data(reference_alignment)
#' data(comparison_alignment)
#' PAC <- compare_alignments(reference_alignment,comparison_alignment)
#' plot_alignment_heatmap(PAC)
#'
#' @note The `plot_alignment_heatmap` displays the similarity between each pairwise column comparison for the reference and comparison multiple sequence alignments. Colour density is determined by the proportion of identical character matches (M) between the columns, normalised to the number of characters that are not merely conserved gaps (not G). The (M) and (not G) values are generated by the `compare_alignments` function as the result list items `$results` and `$means` respectively. This gives a representation of which columns are well agreed upon by the MSAs, and which columns are split by one MSA relative to the other.
#'
plot_alignment_heatmap <- function(x,display=TRUE){
  
  hm_data      <- t(t(x$means)/x$results[2,])
  md           <- reshape2::melt(hm_data)
  colnames(md) <- c('Reference','Comparison','value')

  p <- ggplot2::ggplot(md)                                                   +
       ggplot2::geom_tile(ggplot2::aes(x=Reference,y=Comparison,fill=value)) + 
       ggplot2::scale_fill_gradient("Agreement",low="white",high="black")    +
       ggplot2::theme(plot.background  = ggplot2::element_rect(fill="white"),
                      panel.background = ggplot2::element_rect(fill="white"))

  if (display){
    print(p)
  }
  p
}


#' Plot a summary of column similarity between two multiple sequence alignments 
#'
#' @param x          an object of type "pairwise alignment comparison" (typically the summary file generated by compare_alignments)
#' @param cys        additionally show the cysteine abundance for each column (default = FALSE)
#' @param display    display this plot (default = TRUE)
#' 
#' @export
#' @examples
#' data(reference_alignment)
#' data(comparison_alignment)
#' PAC <- compare_alignments(reference_alignment,comparison_alignment)
#' plot_match_summary(PAC, cys=TRUE)
#'
#' @note This function generates a plot that summarises the agreement between the two multiple sequence alignments. It plots the proportion of identical character matches (M) for each column as a proportion of the characters that are not merely conserved gaps (not G). The overall average proportion of identical characters that are not conserved gaps is overlaid as a percentage. For alignments of cysteine-rich proteins, it can additionally plot the cysteine abundance for each column to indicate columns containing conserved cysteines (`cys=TRUE`).
#'
plot_match_summary <- function(x,cys=FALSE,display=TRUE){
  
  identity       <- x$results[9,]
  proportion_cys <- 0.2*(x$results[3,])-0.2
  score          <- x$score
  col            <- 1:ncol(x$results)
  plot_data      <- data.frame(Identity=identity,PropCys=proportion_cys,Position=col)
  
  p <- ggplot2::ggplot(plot_data,ggplot2::aes(x=Position))                +
       ggplot2::geom_line(ggplot2::aes(y=Identity,colour="Identity"))     +
       ggplot2::theme(legend.title = ggplot2::element_blank())            +
       ggplot2::ylab("Proportion")                                        +
       ggplot2::scale_x_continuous(expand = c(0, 0))                      +
       ggplot2::scale_y_continuous(expand = c(0, 0),breaks=seq(0,1,1/10)) +
       ggplot2::theme_classic()                                           +
       ggplot2::geom_text(label = paste("Av =",percent(score)),
                          hjust = 0,
                          x     = 2,
                          y     = max(identity)*0.95)
  
  if(cys) {
    p  <- p + ggplot2::geom_line(ggplot2::aes(y=PropCys,colour="Cysteines")) +
          ggplot2::geom_line(ggplot2::aes(y=0))                              +
          ggplot2::geom_line(ggplot2::aes(y=0))
  }
  
  if (display){
    print(p)
  }
  p
}

#' Plot the different causes of column dissimilarity between two multiple sequence alignments 
#'
#' @param x          an object of type "pairwise alignment comparison" (typically the summary file generated by compare_alignments)
#' @param stack      stacked area plot in stead of line plot (deault = FALSE)
#' @param display    display this plot (default = TRUE)
#' 
#' @export
#' @examples
#' data(reference_alignment)
#' data(comparison_alignment)
#' PAC <- compare_alignments(reference_alignment,comparison_alignment)
#' plot_category_proportions(PAC, stack=TRUE)
#'
#' @note This function generates a detailed breakdown of the differences between the multiple sequence alignments. For all characters that are neither identical residues, nor conserved gaps, the relative proportions of merges (m), splits (s) and shift (x) is plotted.
#'
plot_category_proportions <- function(x,stack=FALSE,display=TRUE){
  
  plot_data    <- data.frame(Merge=x$results[6,]/(1-x$results[5,]),
                             Split=x$results[7,]/(1-x$results[5,]),
                             Shift=x$results[8,]/(1-x$results[5,]),
                             Position=1:ncol(x$results))
  md           <- reshape2::melt(plot_data,id.vars='Position')
  colnames(md) <- c('Position','Change','Proportion')
  
  if (stack) {
    p <- ggplot2::ggplot(md,ggplot2::aes(x=Position,y=Proportion))                + 
         ggplot2::geom_area(ggplot2::aes(fill=Change),position = 'stack')         + 
         ggplot2::geom_line(ggplot2::aes(data=Change, ymax=1),position = 'stack') +
         ggplot2::scale_x_continuous(expand = c(0, 0))                            +
         ggplot2::scale_y_continuous(expand = c(0, 0))                            +
         ggplot2::theme_classic()
  }
  else {
    p <- ggplot2::ggplot(md,ggplot2::aes(x=Position,y=Proportion)) + 
         ggplot2::geom_line(ggplot2::aes(color=Change))            +
         ggplot2::scale_x_continuous(expand = c(0, 0))             +
         ggplot2::scale_y_continuous(expand = c(0, 0))             +
         ggplot2::theme_classic()
  }
  
  if (display){
    print(p)
  }
  p
}
#########









